{% extends "base.html" %}
{% block title %}PackMan Code{% endblock %}
{% block content %}


<header class="custom-header">
    <h1>Code Pack Panel</h1>
</header>
<br/><br/>


<div class="container">
    <button type="button" class="btn btn-danger" id="backHome">Back</button>
    <br/><br/>
    <div class="accordion" id="accordionExample">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                    Step 1. Data
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <form id="packNameForm">
                        <label for="packName" class="form-label">Pack Name (Required)</label>
                        <input type="text" class="form-control" id="packName" name="pack_name" aria-describedby="pack-name" required>
                    </form>
                    <br/>
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Choose Data Type
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showMessage('file')">Code File</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showMessage('github')">GitHub Code Base</a></li>
                        </ul>
                    </div>
                    <br/>
                    <!-- GitHub Link Input Form, hidden initially -->
                    <div id="githubForm" style="display:none;">
                        <form id="linkForm" onsubmit="handleSubmit(event)">
                            <input type="url" id="linkInput" name="repoURL" class="form-control mt-2" placeholder="Enter GitHub repository link" required>
                            <br/>
                            <button type="submit" class="btn btn-primary" id="fetchButton">Fetch Repo</button>
                            <div id="loadingSpinner" class="spinner-border" role="status" style="display:none;">
                                <span class="sr-only"></span>
                            </div>
                            <button type="button" class="btn btn-secondary" id="resetButton" style="display:none;" onclick="handleReset()">Reset</button>
                        </form>
                    </div>
                    <div id="message" class="mt-3"></div>
                    <!-- Data Entries Display Area -->
                    <div id="dataEntries" class="mt-3" style="max-height: 500px; overflow-y: auto;"></div>
                    <br/>
                    <button id="publishPackButton" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#publishModal" style="display: none;">Publish to Pack</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="publishModal" tabindex="-1" aria-labelledby="publishModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="publishModalLabel">Confirm Publish</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to publish this pack?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="publishCodePack()">Confirm</button>
      </div>
    </div>
  </div>
</div>

<br/><br/>

<script>
    let displayedFiles = new Set();
    let packData = [];  // To store the file content

    document.getElementById('backHome').onclick = function() {
        window.location.href = '/';
    };

    function showMessage(type) {
        const githubForm = document.getElementById('githubForm');
        const packNameInput = document.getElementById('packName');
    
        if (type === 'file') {
            githubForm.style.display = 'none';
            packNameInput.disabled = false;
            document.getElementById('message').innerHTML = `
                <p class="text-danger">You are about to add a code file.</p>
                <form id="fileForm" enctype="multipart/form-data" onsubmit="submitFilesForReading(event)">
                    <input type="file" name="files" class="form-control mt-2" multiple required>
                    <input type="hidden" name="pack_name" value="${packNameInput.value}">
                    <br/>
                    <button type="submit" class="btn btn-primary">Add Data</button>
                </form>
            `;
        } else if (type === 'github') {
            githubForm.style.display = 'block';
            packNameInput.disabled = true;
            document.getElementById('message').innerHTML = ''; 
        }
    }

    function addDataEntry(type, value) {
        const dataEntries = document.getElementById('dataEntries');
        
        if (dataEntries && !displayedFiles.has(value.trim())) {
            const entry = document.createElement('div');
            entry.classList.add('mt-2');
            entry.innerHTML = `
                <input type="text" class="form-control" value="${type}: ${value}" disabled>
            `;
            dataEntries.appendChild(entry);
            displayedFiles.add(value.trim());
        }

        if (displayedFiles.size > 0) {
            document.getElementById('publishPackButton').style.display = 'block';
        }
    }

    function submitFilesForReading(event) {
        event.preventDefault();
        const files = event.target.querySelector('input[name="files"]').files;
        const formData = new FormData();
        
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }

        fetch('/read-files', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }

            console.log("Files received from server:", data);

            packData = [];

            data.forEach(fileData => {
                packData.push({
                    filename: fileData.filename,
                    content: fileData.content,
                    data_type: 'file'
                });
                addDataEntry('File', fileData.filename);
            });

            console.log("Current packData:", packData);
            displayFlashMessage('Files processed successfully!', 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            displayFlashMessage(error.message, 'error');
        });
    }

    function handleSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const fetchButton = document.getElementById('fetchButton');
        const loadingSpinner = document.getElementById('loadingSpinner');

        fetchButton.style.display = 'none';
        loadingSpinner.style.display = 'inline-block';

        fetch('/clear-repo', {
            method: 'POST'
        })
        .then(() => {
            return fetch('/fetch-repo', {
                method: 'POST',
                body: formData
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }

            console.log("Repository files fetched:", data.files);

            const linkInput = document.getElementById('linkInput');
            const resetButton = document.getElementById('resetButton');

            linkInput.disabled = true;
            loadingSpinner.style.display = 'none';
            resetButton.style.display = 'inline-block';

            // Fetch repo files and then retrieve their content
            data.files.forEach(file => {
                addDataEntry('File', file);
                fetchRepoFileContent(file);  // Fetch content for each file
            });

            displayFlashMessage(data.message, 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            loadingSpinner.style.display = 'none';
            fetchButton.style.display = 'inline-block';
            displayFlashMessage(error.message, 'error');
        });
    }

    function fetchRepoFileContent(filename) {
        // Skip directories like .git
        if (filename === '.git') {
            console.log(`Skipping directory: ${filename}`);
            return;  // Skip the .git directory entirely
        }
    
        fetch(`/get-repo-file-content?filename=${encodeURIComponent(filename)}`)
            .then(response => response.json())
            .then(fileData => {
                if (fileData.error) {
                    throw new Error(fileData.error);
                }
    
                packData.push({
                    filename: fileData.filename,
                    content: fileData.content,
                    data_type: 'file'
                });
    
                console.log("Fetched content for file:", fileData);
            })
            .catch(error => {
                console.error('Error fetching file content:', error);
            });
    }
    

    function handleReset() {
        fetch('/clear-repo', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }

            const linkInput = document.getElementById('linkInput');
            const fetchButton = document.getElementById('fetchButton');
            const resetButton = document.getElementById('resetButton');

            linkInput.disabled = false;
            linkInput.value = '';
            fetchButton.style.display = 'inline-block';
            resetButton.style.display = 'none';

            const dataEntries = document.getElementById('dataEntries');
            dataEntries.innerHTML = '';
            displayedFiles.clear();

            document.getElementById('publishPackButton').style.display = 'none';

            displayFlashMessage(data.message, 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            displayFlashMessage(error.message, 'error');
        });
    }

    function displayFlashMessage(message, category) {
        var flashMessageContainer = document.createElement('div');
        flashMessageContainer.className = `alert alert-${category} alert-dismissible fade show`;
        flashMessageContainer.role = 'alert';
        flashMessageContainer.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.insertBefore(flashMessageContainer, document.body.firstChild);

        setTimeout(() => {
            flashMessageContainer.classList.remove('show');
            flashMessageContainer.addEventListener('transitionend', () => flashMessageContainer.remove());
        }, 5000);
    }

    function publishCodePack() {
        const packName = document.getElementById('packName').value;
        if (!packName || displayedFiles.size === 0) {
            displayFlashMessage('Pack name and data entries are required', 'danger');
            return;
        }

        const contents = packData.map(file => ({
            data_type: 'file',
            content: file.content,
            filename: file.filename
        }));

        const payload = {
            pack_name: packName,
            contents: contents
        };

        console.log("Payload being sent to the server:", payload);

        fetch('/packman-code/package_code_pack', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(error => {
                    console.error("Error payload sent to server:", payload);
                    console.error(`HTTP error! status: ${response.status}`);
                    throw new Error(`Failed to publish code pack: ${error.message}`);
                });
            }
            return response.json();
        })
        .then(data => {
            displayFlashMessage('Code pack published successfully!', 'success');
            window.location.reload();
        })
        .catch(error => {
            console.error('Error:', error.message);
            displayFlashMessage(`Failed to publish code pack: ${error.message}`, 'danger');
        });
    }
</script>


{% endblock %}
